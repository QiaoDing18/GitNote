title: 怎么防止被运营商劫持
author: 乔丁
tags:
  - 闲聊
categories:
  - chat
date: 2018-04-27 19:32:00
description: 被面试官问到的
photos: http://p7wm7amg2.bkt.clouddn.com/terror.png
---

运营商通过HTTP劫持进行插入广告，下载软件等

## 运营商劫持原理
1、在用户的浏览器连上被访问的网站服务器，发送了HTTP请求后，运营商的路由器会首先收到此次http请求
2、之后运营商路由器的旁路设备标记此TCP连接为http协议
3、之后可以抢在网站服务器返回数据之前发送http协议的302状态码（临时性重定向，让用户访问新的URI）进行劫持，或者直接返回修改后的html代码
4、浏览器收到302代码后就会跳转到错误的地址，或者修改了html有广告
5、随后返回的真正数据到达后反而会被丢弃

关键点：需要http劫持，首先需要进行标记：如果是http协议，那么进行劫持，否则不进行劫持

## 如何避免
旁路设备中检测http协议的模块比较简单
*一般只会检测TCP连接建立后的第一个数据包，如果其是一个完整的http协议才会被标记*
如果并非是一个完整的http协议，由于无法得到足够多的劫持信息，所以并不会被标记为http协议

所以，防止劫持的方法是：**将http请求分拆到多个数据包内**，进而骗过运行商，防止了http劫持。
而目标网站的操作系统的TCP/IP协议栈比较完善，收到的仍旧是完整的http请求，所以也不会影响网页浏览

## 如何实现
*可以在本地架设一个代理服务器，在代理服务器将浏览器的http请求进行拆包，浏览器设置本地的代理服务器即可。*
而且https也不会劫持